version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - echo "Checking environment variables..."
        - 'echo "EXPO_PUBLIC_SUPABASE_URL: ${EXPO_PUBLIC_SUPABASE_URL:+SET}"'
        - 'echo "SUPABASE_URL: ${SUPABASE_URL:+SET}"'
        - 'echo "EXPO_PUBLIC_SUPABASE_ANON_KEY: ${EXPO_PUBLIC_SUPABASE_ANON_KEY:+SET}"'
        - 'echo "SUPABASE_PUBLISHABLE_KEY: ${SUPABASE_PUBLISHABLE_KEY:+SET}"'
        - echo "Forcing cache clear"
        - rm -rf node_modules
        - rm -rf /tmp/metro-cache
        - rm -rf $HOME/.cache
        - npm cache clean --force
        - npm install
        - export AMPLIFY_BUILD=true
        - export SUPABASE_URL="${SUPABASE_URL}"
        - export SUPABASE_PUBLISHABLE_KEY="${SUPABASE_PUBLISHABLE_KEY}"
        - export EXPO_PUBLIC_SUPABASE_URL="${SUPABASE_URL}"
        - export EXPO_PUBLIC_SUPABASE_ANON_KEY="${SUPABASE_PUBLISHABLE_KEY}"
        - echo "Verifying exports before build:"
        - 'echo "SUPABASE_URL exported: ${SUPABASE_URL:+SET}"'
        - 'echo "SUPABASE_PUBLISHABLE_KEY exported: ${SUPABASE_PUBLISHABLE_KEY:+SET}"'
        - 'echo "EXPO_PUBLIC_SUPABASE_URL exported: ${EXPO_PUBLIC_SUPABASE_URL:+SET}"'
        - 'echo "EXPO_PUBLIC_SUPABASE_ANON_KEY exported: ${EXPO_PUBLIC_SUPABASE_ANON_KEY:+SET}"'
        - SUPABASE_URL="${SUPABASE_URL}" SUPABASE_PUBLISHABLE_KEY="${SUPABASE_PUBLISHABLE_KEY}" EXPO_PUBLIC_SUPABASE_URL="${SUPABASE_URL}" EXPO_PUBLIC_SUPABASE_ANON_KEY="${SUPABASE_PUBLISHABLE_KEY}" npm run build:web
        - |
          # Inject API URL into index.html
          if [ -f dist/index.html ]; then
            API_URL="${API_URL:-http://localhost:3001}"
            echo "API_URL to inject: ${API_URL}"
            # Inject script tag before the closing </head> tag or before <body>
            if grep -q "</head>" dist/index.html; then
              sed -i "s|</head>|<script>window.__API_URL__='${API_URL}';</script></head>|" dist/index.html
            elif grep -q "<body>" dist/index.html; then
              sed -i "s|<body>|<script>window.__API_URL__='${API_URL}';</script><body>|" dist/index.html
            else
              # Fallback: inject at the beginning of the file
              sed -i "1i<script>window.__API_URL__='${API_URL}';</script>" dist/index.html
            fi
            echo "Injected API_URL into index.html: ${API_URL}"
            # Verify injection
            grep -o "window.__API_URL__" dist/index.html && echo "✓ API_URL injection verified" || echo "✗ API_URL injection failed"
          else
            echo "Warning: dist/index.html not found"
          fi
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*

